<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>æˆ‘çš„å¾…åŠæ¸…å• Pro Max</title>
  <meta name="description" content="ç®€å•ã€å“åº”å¼ä¸”æ— éšœç¢çš„å¾…åŠæ¸…å•ç¤ºä¾‹" />
  <style>
    :root{
      --bg-1: #f5f7fb;
      --accent: #6b46c1;
      --accent-600: #5b3ab0;
      --muted: #6b7280;
      --card: #ffffff;
      --danger: #ef4444;
      --success: #16a34a;
      --radius: 12px;
      --gap: 1rem;
      font-size: 16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: linear-gradient(180deg,var(--bg-1),#ffffff 160px);
      color: #0f172a;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      padding:1.25rem;
      line-height:1.45;
    }

    .app{
      max-width:820px;
      margin:0 auto;
      display:flex;
      gap:var(--gap);
      flex-direction:column;
    }

    header.app-header{
      display:flex;
      flex-direction:column;
      gap:0.75rem;
      align-items:stretch;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:0.75rem;
    }
    .logo{
      width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-600));display:flex;align-items:center;justify-content:center;color:white;font-weight:700;
      box-shadow:0 6px 18px rgba(91,58,176,0.12);
    }
    h1{font-size:1.25rem;margin:0;color:var(--accent-600)}
    p.lead{margin:0;color:var(--muted);font-size:0.95rem}

    /* controls */
    .controls{
      display:flex;
      gap:0.75rem;
      flex-wrap:wrap;
      align-items:center;
    }
    form.add-form{
      display:flex;
      gap:0.5rem;
      flex:1;
      min-width:0;
    }
    .input, .select, .search {
      padding:0.6rem 0.75rem;
      border-radius:10px;
      border:1px solid #e6e9ef;
      background:var(--card);
      font-size:0.95rem;
      outline:none;
      transition:box-shadow .15s, border-color .15s;
    }
    .input:focus, .select:focus, .search:focus{
      border-color:var(--accent-600);
      box-shadow:0 0 0 6px rgba(107,70,193,0.06);
    }
    .input{flex:1;min-width:0}
    .select{width:120px}
    button.btn{
      background:var(--accent);
      color:#fff;border:none;padding:0.55rem 0.9rem;border-radius:10px;font-weight:600;cursor:pointer;
    }
    button.btn.secondary{background:#eef2ff;color:var(--accent-600)}
    button.icon-btn{
      background:transparent;border:none;padding:0.35rem;border-radius:8px;cursor:pointer;font-size:1rem;
    }

    /* stats */
    .stats{display:flex;justify-content:space-between;align-items:center;margin-top:0.25rem;color:var(--muted);font-size:0.95rem}

    /* list */
    .todo-wrap{margin-top:1rem}
    ul.todo-list{list-style:none;padding:0;margin:0;display:grid;gap:0.65rem}
    li.task{
      display:flex;align-items:center;justify-content:space-between;
      gap:0.5rem;background:var(--card);padding:0.6rem;border-radius:12px;border:1px solid rgba(12,14,22,0.04);
      transition:transform .12s ease,opacity .12s,box-shadow .12s;
      box-shadow: 0 6px 18px rgba(15,23,42,0.04);
    }
    li.task:focus-within{box-shadow:0 10px 28px rgba(15,23,42,0.06);transform:translateY(-2px)}
    .task-left{display:flex;align-items:center;gap:0.75rem;flex:1;min-width:0}
    .checkbox{
      width:20px;height:20px;border-radius:6px;border:2px solid #ddd;display:inline-flex;align-items:center;justify-content:center;flex-shrink:0;cursor:pointer;
    }
    .checkbox.checked{background:var(--accent);border-color:var(--accent);color:white}
    .priority-badge{font-size:0.75rem;padding:3px 6px;border-radius:6px}
    .p-high{background:#fff5f5;color:#c53030}
    .p-medium{background:#fff8e1;color:#b97701}
    .p-low{background:#f0fff4;color:#15803d}
    .task-text{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:var(--text);display:block}
    .task.completed{opacity:0.7}
    .task.completed .task-text{text-decoration:line-through;color:var(--muted)}
    .task-actions{display:flex;gap:0.4rem;align-items:center}

    /* empty state */
    .empty{padding:2rem;text-align:center;color:var(--muted);border-radius:10px;background:linear-gradient(180deg,#fff,#fbfdff)}

    /* toast / undo */
    .toast{
      position: fixed;
      right: 1rem;
      bottom: 1rem;
      background: rgba(17,24,39,0.95);
      color: white;
      padding:0.6rem 0.9rem;
      border-radius:10px;
      display:flex;gap:0.6rem;align-items:center;
      box-shadow:0 10px 30px rgba(2,6,23,0.4);
      z-index:1200;
    }
    .toast button{background:transparent;border:1px solid rgba(255,255,255,0.18);color:white;padding:0.35rem 0.5rem;border-radius:8px;cursor:pointer}

    /* focus visible */
    :focus{outline: 3px solid rgba(99,102,241,0.14);outline-offset:3px}

    @media(min-width:720px){
      header.app-header{flex-direction:row;align-items:center;justify-content:space-between}
      .brand{gap:1rem}
      form.add-form{max-width:640px}
    }
  </style>
</head>
<body>
  <div class="app" id="app">
    <header class="app-header" aria-labelledby="app-title">
      <div class="brand">
        <div class="logo" aria-hidden="true">TD</div>
        <div>
          <h1 id="app-title">âœ¨ æˆ‘çš„å¾…åŠæ¸…å• Pro+</h1>
          <p class="lead">è½»é‡ã€å“åº”å¼ã€å¯è®¿é—® â€” ç®¡ç†ä½ çš„ä»»åŠ¡</p>
        </div>
      </div>

      <div style="min-width:240px;display:flex;gap:0.5rem;align-items:center">
        <input id="search" class="search" type="search" placeholder="æœç´¢ä»»åŠ¡..." aria-label="æœç´¢ä»»åŠ¡" />
      </div>
    </header>

    <main>
      <section class="controls" aria-label="æ·»åŠ ä»»åŠ¡">
        <form id="add-form" class="add-form" autocomplete="off">
          <select id="priority" class="select" aria-label="ä¼˜å…ˆçº§é€‰æ‹©">
            <option value="high">ğŸ”´ é«˜</option>
            <option value="medium" selected>ğŸŸ¡ ä¸­</option>
            <option value="low">ğŸŸ¢ ä½</option>
          </select>
          <input id="new-task" class="input" type="text" placeholder="è¾“å…¥æ–°ä»»åŠ¡å¹¶å›è½¦æˆ–ç‚¹å‡»æ·»åŠ " aria-label="ä»»åŠ¡å†…å®¹" />
          <button type="submit" class="btn" aria-label="æ·»åŠ ä»»åŠ¡">â• æ·»åŠ </button>
        </form>

        <div style="display:flex;gap:0.5rem;align-items:center">
          <button id="clear-completed" class="btn secondary" type="button" aria-label="æ¸…é™¤å·²å®Œæˆ" hidden>æ¸…é™¤å·²å®Œæˆ</button>
          <button id="clear-all" class="btn secondary" type="button" aria-label="æ¸…é™¤æ‰€æœ‰" hidden>å…¨éƒ¨æ¸…ç©º</button>
        </div>
      </section>

      <div class="stats" aria-live="polite">
        <span id="stats-text">å¾…åŠ: 0 Â· å®Œæˆ: 0</span>
        <div aria-hidden="true" style="font-size:0.9rem;color:var(--muted)">æç¤ºï¼šé€‰ä¸­ä»»åŠ¡å¯ç¼–è¾‘ / åˆ é™¤</div>
      </div>

      <section class="todo-wrap" aria-label="ä»»åŠ¡åˆ—è¡¨">
        <ul id="list" class="todo-list" role="list" aria-live="polite"></ul>
        <div id="empty" class="empty" hidden>åˆ—è¡¨ç©ºç©ºå¦‚ä¹Ÿï¼Œæ·»åŠ ç¬¬ä¸€æ¡ä»»åŠ¡å§ âœ¨</div>
      </section>
    </main>
  </div>

  <!-- template -->
  <template id="task-tpl">
    <li class="task" role="listitem">
      <div class="task-left">
        <button class="checkbox" aria-pressed="false" aria-label="æ ‡è®°å®Œæˆ"></button>
        <span class="priority-badge" aria-hidden="true"></span>
        <span class="task-text"></span>
      </div>
      <div class="task-actions">
        <button class="icon-btn edit" type="button" aria-label="ç¼–è¾‘ä»»åŠ¡">âœï¸</button>
        <button class="icon-btn delete" type="button" aria-label="åˆ é™¤ä»»åŠ¡">ğŸ—‘ï¸</button>
      </div>
    </li>
  </template>

  <!-- toast -->
  <div id="toast-root" aria-live="polite" style="position:fixed;right:1rem;bottom:1rem;"></div>

  <script>
    (function(){
      // å…ƒç´ 
      const listEl = document.getElementById('list');
      const tpl = document.getElementById('task-tpl');
      const addForm = document.getElementById('add-form');
      const newTaskInput = document.getElementById('new-task');
      const prioritySelect = document.getElementById('priority');
      const searchInput = document.getElementById('search');
      const statsText = document.getElementById('stats-text');
      const emptyEl = document.getElementById('empty');
      const clearCompletedBtn = document.getElementById('clear-completed');
      const clearAllBtn = document.getElementById('clear-all');
      const toastRoot = document.getElementById('toast-root');

      const STORAGE_KEY = 'my_todos_v2';
      let tasks = loadFromStorage();
      let lastDeleted = null;
      let undoTimer = null;

      function uid(){
        return Date.now().toString(36) + '-' + Math.random().toString(36).slice(2,8);
      }

      function loadFromStorage(){
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          return raw ? JSON.parse(raw) : [];
        } catch(e){ return []; }
      }
      function saveToStorage(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(tasks)); }

      function updateStats(){
        const completed = tasks.filter(t=>t.completed).length;
        const pending = tasks.length - completed;
        statsText.textContent = `å¾…åŠ: ${pending} Â· å®Œæˆ: ${completed}`;
        clearCompletedBtn.hidden = completed === 0;
        clearAllBtn.hidden = tasks.length === 0;
      }

      function getBadge(priority){
        if(priority==='high') return {cls:'p-high', text:'æ€¥'};
        if(priority==='medium') return {cls:'p-medium', text:'ä¸­'};
        return {cls:'p-low', text:'ç¼“'};
      }

      function render(){
        // æ’åºï¼šæœªå®ŒæˆæŒ‰ä¼˜å…ˆçº§ï¼Œå·²å®Œæˆæ’å
        tasks.sort((a,b)=>{
          if(a.completed !== b.completed) return a.completed ? 1 : -1;
          if(!a.completed && !b.completed) {
            const w = {high:3,medium:2,low:1};
            return w[b.priority] - w[a.priority];
          }
          return 0;
        });

        // æ¸…ç©º
        listEl.innerHTML = '';
        const q = (searchInput.value || '').trim().toLowerCase();
        let visible = 0;

        tasks.forEach(task=>{
          const item = tpl.content.firstElementChild.cloneNode(true);
          // set attributes / data
          item.dataset.id = task.id;

          const checkbox = item.querySelector('.checkbox');
          const badge = item.querySelector('.priority-badge');
          const txt = item.querySelector('.task-text');

          // badge
          if(!task.completed){
            const b = getBadge(task.priority);
            badge.className = 'priority-badge ' + b.cls;
            badge.textContent = b.text;
            badge.style.display = '';
          } else {
            badge.style.display = 'none';
          }

          // text (use textContent to avoid XSS)
          txt.textContent = task.text;

          // checked state
          if(task.completed){
            item.classList.add('completed');
            checkbox.classList.add('checked');
            checkbox.setAttribute('aria-pressed','true');
            checkbox.innerHTML = 'âœ”';
          } else {
            checkbox.classList.remove('checked');
            checkbox.setAttribute('aria-pressed','false');
            checkbox.innerHTML = '';
          }

          // search filter: hide by style while keep DOM (ä¾¿äº index å›ºå®š)
          if(q && !task.text.toLowerCase().includes(q)){
            item.style.display = 'none';
          } else {
            visible++;
          }

          listEl.appendChild(item);
        });

        emptyEl.hidden = tasks.length !== 0 && visible > 0;
        if(tasks.length === 0) { emptyEl.hidden = false; }
        updateStats();
        saveToStorage();
      }

      // event delegation for toggle/edit/delete
      listEl.addEventListener('click', (e)=>{
        const el = e.target;
        const li = el.closest('li.task');
        if(!li) return;
        const id = li.dataset.id;
        if(el.classList.contains('checkbox')){
          toggleComplete(id);
        } else if(el.classList.contains('edit')){
          editTask(id);
        } else if(el.classList.contains('delete')){
          deleteTask(id);
        } else if(el.closest('.task-left') && el.tagName !== 'BUTTON'){
          // ç‚¹å‡»æ–‡æœ¬åŒºåŸŸåˆ‡æ¢å®Œæˆï¼ˆå¯é€‰ï¼‰ï¼šå°† focus ç»™äºˆ checkbox
          const cb = li.querySelector('.checkbox');
          cb.focus();
        }
      });

      // keyboard accessibility: space on focused checkbox toggles
      listEl.addEventListener('keydown', (e)=>{
        const el = e.target;
        if(el.classList && el.classList.contains('checkbox') && (e.key === ' ' || e.key === 'Spacebar' || e.key === 'Enter')){
          e.preventDefault();
          el.click();
        }
      });

      function toggleComplete(id){
        const t = tasks.find(x=>x.id===id);
        if(!t) return;
        t.completed = !t.completed;
        render();
      }

      function editTask(id){
        const t = tasks.find(x=>x.id===id);
        if(!t) return;
        const newText = prompt('ç¼–è¾‘ä»»åŠ¡å†…å®¹ï¼š', t.text);
        if(newText !== null){
          const v = newText.trim();
          if(v){
            t.text = v;
            render();
          }
        }
      }

      function deleteTask(id){
        const idx = tasks.findIndex(x=>x.id===id);
        if(idx === -1) return;
        lastDeleted = tasks.splice(idx,1)[0];
        render();
        showUndoToast(`å·²åˆ é™¤ï¼š${lastDeleted.text}`, undoDelete);
      }

      function undoDelete(){
        if(!lastDeleted) return;
        tasks.push(lastDeleted);
        lastDeleted = null;
        render();
        clearToast();
      }

      function showUndoToast(message, undoCb){
        clearToast();
        const node = document.createElement('div');
        node.className = 'toast';
        node.innerHTML = `<div style="font-size:0.95rem">${message}</div>`;
        const btn = document.createElement('button');
        btn.textContent = 'æ’¤é”€';
        btn.addEventListener('click', ()=>{
          undoCb && undoCb();
        });
        node.appendChild(btn);
        toastRoot.appendChild(node);
        // auto dismiss after 6s
        undoTimer = setTimeout(()=> { clearToast(); lastDeleted = null; }, 6000);
      }
      function clearToast(){
        toastRoot.innerHTML = '';
        if(undoTimer){ clearTimeout(undoTimer); undoTimer = null; }
      }

      // add new
      addForm.addEventListener('submit', (e)=>{
        e.preventDefault();
        const text = newTaskInput.value.trim();
        if(!text) return newTaskInput.focus();
        const t = {
          id: uid(),
          text,
          priority: prioritySelect.value,
          completed: false,
          createdAt: Date.now()
        };
        tasks.push(t);
        newTaskInput.value = '';
        prioritySelect.value = 'medium';
        searchInput.value = '';
        render();
        newTaskInput.focus();
      });

      // keypress on input: Enter handled by form submit already

      // clear completed
      clearCompletedBtn.addEventListener('click', ()=>{
        if(!confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰å·²å®Œæˆçš„ä»»åŠ¡å—ï¼Ÿ')) return;
        tasks = tasks.filter(t=>!t.completed);
        render();
      });

      // clear all
      clearAllBtn.addEventListener('click', ()=>{
        if(tasks.length === 0) return;
        if(!confirm('âš ï¸ è¿™å°†åˆ é™¤æ‰€æœ‰ä»»åŠ¡ï¼Œç¡®å®šå—ï¼Ÿ')) return;
        tasks = [];
        render();
      });

      // search
      searchInput.addEventListener('input', ()=>{
        render();
      });

      // initial render
      render();

      // expose for debugging (optional)
      window.__todo = {tasks, render};
    })();
  </script>
</body>
</html>